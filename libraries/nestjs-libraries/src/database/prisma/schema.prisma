// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  runtime  = "nodejs"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                String             @id @default(uuid())
  name              String
  description       String?
  apiKey            String?
  users             UserOrganization[]
  media             Media[]
  paymentId         String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  github            GitHub[]
  subscription      Subscription?
  Integration       Integration[]
  post              Post[]             @relation("organization")
  submittedPost     Post[]             @relation("submittedForOrg")
  allowTrial        Boolean            @default(false)
  isTrailing        Boolean            @default(false)
  Comments          Comments[]
  notifications     Notifications[]
  buyerOrganization MessagesGroup[]
  usedCodes         UsedCodes[]
  credits           Credits[]
  plugs             Plugs[]
  customers         Customer[]
  webhooks          Webhooks[]
  tags              Tags[]
  signatures        Signatures[]
  autoPost          AutoPost[]
  sets              Sets[]
  thirdParty        ThirdParty[]
  errors            Errors[]
  setterConfigs     SetterConfig[]
}

model Tags {
  id           String       @id @default(uuid())
  name         String
  color        String
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id])
  posts        TagsPosts[]
  deletedAt    DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([orgId])
  @@index([deletedAt])
}

model TagsPosts {
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  tagId     String
  tag       Tags     @relation(fields: [tagId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([postId, tagId])
  @@unique([postId, tagId])
}

model User {
  id                    String              @id @default(uuid())
  email                 String
  password              String?
  providerName          Provider
  name                  String?
  lastName              String?
  isSuperAdmin          Boolean             @default(false)
  bio                   String?
  audience              Int                 @default(0)
  pictureId             String?
  picture               Media?              @relation(fields: [pictureId], references: [id])
  providerId            String?
  organizations         UserOrganization[]
  timezone              Int
  comments              Comments[]
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  lastReadNotifications DateTime            @default(now())
  inviteId              String?
  activated             Boolean             @default(true)
  items                 ItemUser[]
  marketplace           Boolean             @default(true)
  account               String?
  connectedAccount      Boolean             @default(false)
  groupBuyer            MessagesGroup[]     @relation("groupBuyer")
  groupSeller           MessagesGroup[]     @relation("groupSeller")
  orderBuyer            Orders[]            @relation("orderBuyer")
  orderSeller           Orders[]            @relation("orderSeller")
  payoutProblems        PayoutProblems[]
  lastOnline            DateTime            @default(now())
  agencies              SocialMediaAgency[]
  ip                    String?
  agent                 String?

  @@unique([email, providerName])
  @@index([lastReadNotifications])
  @@index([inviteId])
  @@index([account])
  @@index([lastOnline])
  @@index([pictureId])
}

model UsedCodes {
  id           String       @id @default(uuid())
  code         String
  orgId        String
  organization Organization @relation(fields: [orgId], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([code])
}

model UserOrganization {
  id             String       @id @default(uuid())
  user           User         @relation(fields: [userId], references: [id])
  userId         String
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  disabled       Boolean      @default(false)
  role           Role         @default(USER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([userId, organizationId])
  @@index([disabled])
}

model GitHub {
  id             String       @id @default(uuid())
  login          String?
  name           String?
  token          String
  jobId          String?
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([login])
  @@index([organizationId])
}

model Trending {
  id           String   @id @default(uuid())
  trendingList String
  language     String?
  hash         String
  date         DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([language])
  @@index([hash])
}

model TrendingLog {
  id       String   @id @default(uuid())
  language String?
  date     DateTime
}

model ItemUser {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id])
  userId String
  key    String

  @@unique([userId, key])
  @@index([userId])
  @@index([key])
}

model Star {
  id         String   @id @default(uuid())
  stars      Int
  totalStars Int
  forks      Int
  totalForks Int
  login      String
  date       DateTime @default(now()) @db.Date
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([login, date])
}

model Media {
  id                 String              @id @default(uuid())
  name               String
  path               String
  organization       Organization        @relation(fields: [organizationId], references: [id])
  organizationId     String
  thumbnail          String?
  thumbnailTimestamp Int?
  alt                String?
  fileSize           Int                 @default(0)
  type               String              @default("image")
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  userPicture        User[]
  agencies           SocialMediaAgency[]
  deletedAt          DateTime?

  @@index([name])
  @@index([organizationId])
  @@index([type])
}

model SocialMediaAgency {
  id      String  @id @default(uuid())
  user    User    @relation(fields: [userId], references: [id])
  userId  String  @unique()
  name    String
  logoId  String?
  logo    Media?  @relation(fields: [logoId], references: [id])
  website String?
  slug    String?

  facebook         String?
  instagram        String?
  twitter          String?
  linkedIn         String?
  youtube          String?
  tiktok           String?
  otherSocialMedia String?

  shortDescription String
  description      String
  niches           SocialMediaAgencyNiche[]
  approved         Boolean                  @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  @@index([userId])
  @@index([deletedAt])
  @@index([id])
}

model SocialMediaAgencyNiche {
  agencyId String
  agency   SocialMediaAgency @relation(fields: [agencyId], references: [id])
  niche    String

  @@id([agencyId, niche])
}

model Credits {
  id             String       @id @default(uuid())
  organization   Organization @relation(fields: [organizationId], references: [id])
  organizationId String
  credits        Int
  type           String       @default("ai_images")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([createdAt])
}

model Subscription {
  id               String           @id @default(cuid())
  organizationId   String           @unique
  organization     Organization     @relation(fields: [organizationId], references: [id])
  subscriptionTier SubscriptionTier
  identifier       String?
  cancelAt         DateTime?
  period           Period
  totalChannels    Int
  isLifetime       Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  @@index([organizationId])
  @@index([subscriptionTier])
}

model Integration {
  id                String                 @id @default(uuid())
  name              String?
  picture           String?
  type              String
  providerIdentifier String?
  token             String?
  refreshToken      String?
  expiresIn         Int?
  username          String?
  isBetweenSteps    Boolean                @default(false)
  disabled          Boolean                @default(false)
  inBetweenSteps    Json?
  organizationId    String
  organization      Organization           @relation(fields: [organizationId], references: [id])
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  posts             Post[]
  customUrl         String?
  time              String?
  profile           String?
  deletedAt         DateTime?
  integrationId     String?
  additionalSettings Json?
  comments          Comments[]
  notifications     Notifications[]
  customer          Customer[]
  plugs             Plugs[]
  orderItems        OrderItems[]
  exisingPlugData   ExisingPlugData[]
  signatures        Signatures[]
  webhooks          IntegrationsWebhooks[]

  @@index([organizationId])
  @@index([disabled])
  @@index([deletedAt])
  @@index([integrationId])
}

model Customer {
  id             String       @id @default(uuid())
  integrationId  String
  integration    Integration  @relation(fields: [integrationId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  customerId     String
  customerName   String?
  avatar         String?
  description    String?
  lastUpdate     DateTime     @default(now())
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([customerId, integrationId])
  @@index([integrationId])
  @@index([organizationId])
  @@index([customerId])
  @@index([lastUpdate])
}

model Signatures {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  integrationId  String
  integration    Integration  @relation(fields: [integrationId], references: [id])
  signature      String       @db.Text
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([integrationId])
  @@index([organizationId])
}

model Post {
  id                String          @id @default(uuid())
  organizationId    String
  organization      Organization    @relation("organization", fields: [organizationId], references: [id])
  submittedForOrder String?
  submittedForOrg   Organization?   @relation("submittedForOrg", fields: [submittedForOrder], references: [id])
  title             String?
  description       String?
  integrationId     String
  integration       Integration     @relation(fields: [integrationId], references: [id])
  postedAt          DateTime?
  group             String?
  state             State           @default(DRAFT)
  publishDate       DateTime?       @db.Timestamptz(3)
  settings          Json?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  deletedAt         DateTime?
  threadId          String?
  thread            Post?           @relation("PostThread", fields: [threadId], references: [id])
  threadPosts       Post[]          @relation("PostThread")
  approvedSubmit    APPROVED_SUBMIT_FOR_ORDER @default(NO)
  tags              TagsPosts[]
  order             Orders?         @relation(fields: [orderId], references: [id])
  orderId           String?
  messages          Messages?       @relation(fields: [messageId], references: [id])
  messageId         String?
  payoutProblems    PayoutProblems[]
  errors            Errors[]

  @@index([integrationId])
  @@index([organizationId])
  @@index([group])
  @@index([publishDate])
  @@index([state])
  @@index([createdAt])
  @@index([deletedAt])
  @@index([submittedForOrder])
  @@index([messageId])
}

model Comments {
  id             String       @id @default(uuid())
  postId         String?
  userId         String
  user           User         @relation(fields: [userId], references: [id])
  comment        String
  customerId     String?
  integrationId  String
  integration    Integration  @relation(fields: [integrationId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  repliedId      String?
  replied        Comments?    @relation("CommentReplies", fields: [repliedId], references: [id])
  replies        Comments[]   @relation("CommentReplies")
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([integrationId])
  @@index([organizationId])
  @@index([userId])
  @@index([repliedId])
  @@index([createdAt])
  @@index([deletedAt])
}

model Notifications {
  id             String       @id @default(uuid())
  integrationId  String
  integration    Integration  @relation(fields: [integrationId], references: [id])
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  content        String
  link           String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?

  @@index([createdAt])
  @@index([organizationId])
  @@index([deletedAt])
}

model MessagesGroup {
  id                  String       @id @default(uuid())
  buyerOrganizationId String
  buyerOrganization   Organization @relation(fields: [buyerOrganizationId], references: [id])
  buyerId             String
  buyer               User         @relation("groupBuyer", fields: [buyerId], references: [id])
  sellerId            String
  seller              User         @relation("groupSeller", fields: [sellerId], references: [id])
  messages            Messages[]
  orders              Orders[]
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt

  @@unique([buyerId, sellerId])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([buyerOrganizationId])
}

model PayoutProblems {
  id        String   @id @default(uuid())
  status    String
  orderId   String
  order     Orders   @relation(fields: [orderId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  postId    String?
  post      Post?    @relation(fields: [postId], references: [id])
  amount    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Orders {
  id             String           @id @default(uuid())
  buyerId        String
  sellerId       String
  posts          Post[]
  buyer          User             @relation("orderBuyer", fields: [buyerId], references: [id])
  seller         User             @relation("orderSeller", fields: [sellerId], references: [id])
  status         OrderStatus
  ordersItems    OrderItems[]
  messageGroupId String
  messageGroup   MessagesGroup    @relation(fields: [messageGroupId], references: [id])
  captureId      String?
  payoutProblems PayoutProblems[]
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  @@index([buyerId])
  @@index([sellerId])
  @@index([updatedAt])
  @@index([createdAt])
  @@index([messageGroupId])
}

model OrderItems {
  id            String      @id @default(uuid())
  orderId       String
  order         Orders      @relation(fields: [orderId], references: [id])
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id])
  quantity      Int
  price         Int

  @@index([orderId])
  @@index([integrationId])
}

model Messages {
  id        String        @id @default(uuid())
  from      From
  content   String?
  groupId   String
  group     MessagesGroup @relation(fields: [groupId], references: [id])
  special   String?
  posts     Post[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  deletedAt DateTime?

  @@index([groupId])
  @@index([createdAt])
  @@index([deletedAt])
}

model Plugs {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  plugFunction   String
  data           String
  integrationId  String
  integration    Integration  @relation(fields: [integrationId], references: [id])
  activated      Boolean      @default(true)

  @@unique([plugFunction, integrationId])
  @@index([organizationId])
}

model ExisingPlugData {
  id            String      @id @default(uuid())
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id])
  methodName    String
  value         String

  @@unique([integrationId, methodName, value])
}

model PopularPosts {
  id        String   @id @default(uuid())
  category  String
  topic     String
  content   String
  hook      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model IntegrationsWebhooks {
  integrationId String
  integration   Integration @relation(fields: [integrationId], references: [id])
  webhookId     String
  webhook       Webhooks    @relation(fields: [webhookId], references: [id])

  @@id([integrationId, webhookId])
  @@unique([integrationId, webhookId])
  @@index([integrationId])
  @@index([webhookId])
}

model Webhooks {
  id             String                 @id @default(uuid())
  name           String
  organizationId String
  organization   Organization           @relation(fields: [organizationId], references: [id])
  integrations   IntegrationsWebhooks[]
  url            String
  deletedAt      DateTime?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([organizationId])
  @@index([deletedAt])
}

model AutoPost {
  id              String       @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  title           String
  content         String?
  onSlot          Boolean
  syncLast        Boolean
  url             String
  lastUrl         String
  active          Boolean
  addPicture      Boolean
  generateContent Boolean
  integrations    String
  deletedAt       DateTime?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  @@index([deletedAt])
}

model Sets {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  name           String
  content        String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
}

model ThirdParty {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  identifier     String
  name           String
  internalId     String
  apiKey         String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?

  @@unique([organizationId, internalId])
  @@index([organizationId])
  @@index([deletedAt])
}

model Errors {
  id             String       @id @default(uuid())
  message        String
  body           String       @default("{}")
  platform       String
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  postId         String
  post           Post         @relation(fields: [postId], references: [id])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@index([createdAt])
}

model Mentions {
  name      String
  username  String
  platform  String
  image     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([name, username, platform, image])
  @@index([createdAt])
}

// ====================================
// CETERIA AI SETTER MODULE
// ====================================

model SetterConfig {
  id                    String         @id @default(uuid())
  organizationId        String         @map("organization_id")
  organization          Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name                  String
  persona               String         @db.Text
  systemPrompt          String         @map("system_prompt") @db.Text
  qualificationCriteria Json           @map("qualification_criteria")
  calendarType          String?        @map("calendar_type")
  calendarCredentials   String?        @map("calendar_credentials") @db.Text
  isActive              Boolean        @default(true) @map("is_active")
  createdAt             DateTime       @default(now()) @map("created_at")
  updatedAt             DateTime       @updatedAt @map("updated_at")
  
  conversations         Conversation[]
  
  @@map("setter_configs")
  @@index([organizationId])
  @@index([isActive])
}

model Conversation {
  id               String         @id @default(uuid())
  setterConfigId   String         @map("setter_config_id")
  setterConfig     SetterConfig   @relation(fields: [setterConfigId], references: [id], onDelete: Cascade)
  platform         String
  prospectId       String         @map("prospect_id")
  prospectUsername String?        @map("prospect_username")
  status           String         @default("active")
  messages         Json           @default("[]")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  
  extractedLeads   ExtractedLead[]
  
  @@map("conversations")
  @@index([setterConfigId])
  @@index([status])
  @@index([platform])
  @@index([prospectId])
}

model ExtractedLead {
  id                  String       @id @default(uuid())
  conversationId      String       @map("conversation_id")
  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  extractedData       Json         @map("extracted_data")
  qualificationScore  Int?         @map("qualification_score")
  nextAction          String?      @map("next_action")
  bookedAt            DateTime?    @map("booked_at")
  meetingLink         String?      @map("meeting_link") @db.Text
  createdAt           DateTime     @default(now()) @map("created_at")
  
  @@map("extracted_leads")
  @@index([conversationId])
  @@index([qualificationScore])
  @@index([nextAction])
}

enum OrderStatus {
  PENDING
  ACCEPTED
  CANCELED
  COMPLETED
}

enum From {
  BUYER
  SELLER
}

enum State {
  QUEUE
  PUBLISHED
  ERROR
  DRAFT
}

enum SubscriptionTier {
  STANDARD
  PRO
  TEAM
  ULTIMATE
}

enum Period {
  MONTHLY
  YEARLY
}

enum Provider {
  LOCAL
  GITHUB
  GOOGLE
  FARCASTER
  WALLET
  GENERIC
}

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

enum APPROVED_SUBMIT_FOR_ORDER {
  NO
  WAITING_CONFIRMATION
  YES
}
